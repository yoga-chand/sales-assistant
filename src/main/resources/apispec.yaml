openapi: 3.0.3
info:
  title: Sales-Assistant API
  version: "1.0.0"
  description: >
    Secure Chatbot API Platform — Sales-Assistant
    - JWT-based auth with RBAC (ADMIN, ANALYST, GUEST)
    - Guest chat without history
    - Conversations and messages with citations

servers:
  - url: http://localhost:8080/v1
    description: Local server

tags:
  - name: Auth
  - name: Conversations
  - name: Messages
  - name: Guest

paths:
  /auth/login:
    post:
      tags: [Auth]
      summary: Login and retrieve a JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: analyst@demo
              password: analyst
      responses:
        '200':
          description: JWT issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
              example:
                userId: u2
                email: analyst@demo
                roles: [ROLE_ANALYST]
                accessToken: eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzYWxlcy1hc3Npc3RhbnQiLCJzdWIiOiJ1MiIsImF1ZCI6ImFwaSIsImlhdCI6MTc2MTQ1MjE4NSwiZXhwIjoxNzYxNDU1Nzg1LCJlbWFpbCI6ImFuYWx5c3RAZGVtbyIsInJvbGVzIjpbIlJPTEVfQU5BTFlTVCJdLCJzY29wZXMiOlsia2I6cmVhZDpkZXRhaWwiLCJjaGF0Omludm9rZSIsImNvbnY6cmVhZCIsImNvbnY6d3JpdGUiXX0.tAHODgEBoD9yXL1583QI1otrFD4QqA53gO320D-7IGA
                tokenType: Bearer
                expiresInSeconds: 3600
        '401':
          description: Invalid credentials

  /conversations:
    post:
      tags: [Conversations]
      summary: Create a conversation and get assistant’s initial response
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConversationRequest'
            example:
              title: "Summarize Apple’s iPhone sales trends in FY2024."
      responses:
        '200':
          description: Conversation created with first assistant response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateConversationResponse'
              example:
                conversationId: 32b9e8be-a658-4255-82a6-cc32520187dd
                answer: |
                  ### iPhone Sales Trends in FY2024

                  - **Units Sold**: 224.7 million
                  - **Average Selling Price (ASP)**: $923
                  - **Product Mix**:
                    - Pro/Pro Max: 58%
                    - Plus: 14%
                    - Base: 28%
                  
                  - **Key Drivers**:
                    - Continued emphasis on trade-ins
                    - Premium product skew
                    - Enhanced camera and AI features
                    - Expansion of retail presence in the APAC region

                  - **Regional Notables**:
                    - **Americas**: Carrier buy-one-get-one (BOGO) promotions boosted the Pro Max mix.
                    - **Greater China**: Introduction of retail-exclusive color options.
                    - **RAPAC**: Improved conversion rates due to installment financing options.

                  Overall, FY2024 saw a positive trend in iPhone sales, driven by strategic promotions and product enhancements.
                idempotencyKey: a6e564c1-32be-47b5-a670-54cdc5d1adb3
                latency: 5417
                roleBanner: "ROLE=ANALYST"
                createdAt: "2025-10-26T04:16:46.395015Z"
        '401':
          description: Missing or invalid token
        '403':
          description: Insufficient role (requires ANALYST or ADMIN)

  /conversations/{conversationId}:
    get:
      tags: [Conversations]
      summary: Get conversation metadata
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversation metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationMetadataResponse'
              example:
                createdAt: "2025-10-25T23:52:44.734455Z"
                id: "00fa17ff-a850-4574-9fe5-d364e50005b9"
                title: "Generate a summary of promotions and pricing"
                userId: "u3"
        '401':
          description: Missing or invalid token
        '403':
          description: Insufficient role (requires ANALYST or ADMIN)
        '404':
          description: Conversation not found

  /conversations/{conversationId}/messages:
    get:
      tags: [Messages]
      summary: List all messages for a conversation
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Message list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationMessagesResponse'
              example:
                conversationId: "00fa17ff-a850-4574-9fe5-d364e50005b9"
                messages:
                  - createdAt: "2025-10-25T23:52:44.752879Z"
                    role: "user"
                    id: "fba9aa95-7b60-4e84-a509-1e254a29ed2f"
                    content: ""
                  - createdAt: "2025-10-25T23:52:48.474653Z"
                    role: "assistant"
                    id: "774938c6-5843-49c6-aa1e-941fdbde0a37"
                    content: |
                      ### Promotions & Pricing Summary

                      - **Trade-in Credit**: Average trade-in credit is $385 for iPhone 13, 14, and 15 owners.
                      
                      - **Bundles**: 
                        - Back-to-school promotions in the Americas and festive promotions in India have successfully lifted Average Order Value (AOV) by 12–15%.

                      - **Pricing Strategy**: 
                        - Selective price protection measures are in place in Japan due to foreign exchange (FX) fluctuations.
        '401':
          description: Missing or invalid token
        '403':
          description: Insufficient role (requires ANALYST or ADMIN)
        '404':
          description: Conversation not found

    post:
      tags: [Messages]
      summary: Post a user message and receive assistant reply
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostMessageRequest'
            example:
              message: "How many units sold"
      responses:
        '200':
          description: Assistant reply with optional citations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssistantReplyResponse'
              example:
                conversationId: "00fa17ff-a850-4574-9fe5-d364e50005b9"
                answer: |
                  ### iPhone Units Sold
                  - FY2023: 219.0 million
                  - FY2024: 224.7 million

                  ### Mac Units Sold
                  - FY2023: 21.1 million

                  ### iPad Units Sold
                  - FY2023: 48.2 million
                idempotencyKey: "998e5a87-91d2-456f-aed4-bf48a2a2ade1"
                latency: 2505
                roleBanner: "ROLE=ANALYST"
                createdAt: "2025-10-26T04:56:57.096108Z"
        '401':
          description: Missing or invalid token
        '403':
          description: Insufficient role (requires ANALYST or ADMIN)
        '404':
          description: Conversation not found

  /messages:complete:
    post:
      tags: [Guest]
      summary: Guest chat (no auth, no history)
      description: >
        Allows guests to ask a single question and receive an answer.
        No conversation is persisted (depending on your implementation, a transient conversationId may be returned).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GuestCompleteRequest'
            example:
              message: "Summarize Apple’s iPhone sales trends in FY2024."
      responses:
        '200':
          description: Guest answer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuestCompleteResponse'
              example:
                conversationId: "a2bf01a0-0ef6-4fa6-afdf-8bdf25ce2299"
                answer: "I don’t have enough data in the current context to answer that confidently."
                idempotencyKey: "a2bf01a0-0ef6-4fa6-afdf-8bdf25ce2299"
                latency: 2396
                roleBanner: "ROLE_GUEST"
                createdAt: "2025-10-26T04:17:43.535535Z"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    LoginRequest:
      type: object
      properties:
        email: { type: string }
        password: { type: string }
      required: [email, password]

    LoginResponse:
      type: object
      properties:
        userId: { type: string }
        email: { type: string }
        roles:
          type: array
          items: { type: string }
        accessToken:
          type: string
          description: JWT access token
        tokenType:
          type: string
          example: Bearer
        expiresInSeconds:
          type: integer
          format: int64

    CreateConversationRequest:
      type: object
      properties:
        title:
          type: string
          description: Initial user prompt/title
      required: [title]

    CreateConversationResponse:
      type: object
      properties:
        conversationId:
          type: string
          format: uuid
        answer:
          type: string
        idempotencyKey:
          type: string
        latency:
          type: integer
          format: int64
        roleBanner:
          type: string
        createdAt:
          type: string
          format: date-time
      required: [conversationId, answer, createdAt]

    ConversationMetadataResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        createdAt:
          type: string
          format: date-time
        userId:
          type: string

    Message:
      type: object
      properties:
        id: { type: string, format: uuid }
        role: { type: string, enum: ["user","assistant"] }
        content: { type: string }
        createdAt: { type: string, format: date-time }

    ConversationMessagesResponse:
      type: object
      properties:
        conversationId:
          type: string
          format: uuid
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
      required: [conversationId, messages]

    PostMessageRequest:
      type: object
      properties:
        message:
          type: string
      required: [message]

    AssistantReplyResponse:
      type: object
      properties:
        conversationId:
          type: string
          format: uuid
        answer:
          type: string
        idempotencyKey:
          type: string
        latency:
          type: integer
          format: int64
        roleBanner:
          type: string
        createdAt:
          type: string
          format: date-time

    GuestCompleteRequest:
      type: object
      properties:
        message: { type: string }
        includeCitations:
          type: boolean
          default: false
        topK:
          type: integer
          default: 3
      required: [message]

    GuestCompleteResponse:
      type: object
      properties:
        conversationId:
          type: string
          format: uuid
        answer:
          type: string
        idempotencyKey:
          type: string
        latency:
          type: integer
          format: int64
        roleBanner:
          type: string
        createdAt:
          type: string
          format: date-time
